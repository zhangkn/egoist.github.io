{"tags":[{"name":"javascript","permalink":"https://egoist.moe/tags/javascript/","url":"/async/tags/javascript.json","count":11},{"name":"story","permalink":"https://egoist.moe/tags/story/","url":"/async/tags/story.json","count":1}],"categories":[],"url":"/async/posts/2018/02/27/my-rollup-plugin-postcss.json","date":1519712894000,"path":{"year":2018,"month":2,"day":27,"name":"my-rollup-plugin-postcss"},"title":"我的 rollup-plugin-postcss","permalink":"https://egoist.moe/2018/02/27/my-rollup-plugin-postcss/","content":"<p><a href=\"https://github.com/egoist/rollup-plugin-postcss\" target=\"_blank\" rel=\"external\">rollup-plugin-postcss</a> 是我两年前开源的一个项目，用于为 <a href=\"https://rollupjs.org/guide/en\" target=\"_blank\" rel=\"external\">Rollup</a> 提供 <a href=\"https://github.com/postcss/postcss\" target=\"_blank\" rel=\"external\">PostCSS</a> 支持。</p>\n<p>这基本上是我刚开始工作的时候写的代码，所以见证了我一段心路历程。</p>\n<h2 id=\"2015-nian12-yue8-ri\">2015 年 12 月 8 日</h2>\n<p>我<a href=\"https://github.com/egoist/rollup-plugin-postcss/commit/ed445b067e0772aa39403db23bfb2bc4b6129aef#diff-04c6e90faac2675aa89e2176d2eec7d8\" target=\"_blank\" rel=\"external\">首次提交了代码</a>，那个时候我的邮箱还是 <code>aprilorange.net@icloud.com</code><sup class=\"footnote-ref\"><a href=\"#fn1\" id=\"fnref1\">[1]</a></sup>，不过早已由于忘记密码且无法申诉而永久无法登录了。</p>\n<p>当时的代码极为简单，仅仅是调用 <code>postcss</code> 转换 CSS 代码并提供 <code>plugins</code> 参数:</p>\n<pre><code class=\"language-js\">import postcss from 'postcss';\nimport styleInject from 'style-inject';\n \nexport default function (options = {}) {\n  return {\n    intro () {\n      return styleInject.toString();\n    },\n    transform (code, id) {\n      if (id.slice( -4 ) !== '.css') {\n        return null;\n      }\n      code = postcss(options.plugins || []).process(code).css;\n      code = `export default styleInject(${JSON.stringify(code)});`\n      return {\n        code,\n        map: { mappings: '' }\n      };\n    }\n  };\n};\n</code></pre>\n<p>之后就在当天，我向 PostCSS 项目提交 PR 请求在 README 上列出我的这个项目，而这个 PR 的序号也很溜: <a href=\"https://github.com/postcss/postcss/pull/666\" target=\"_blank\" rel=\"external\">https://github.com/postcss/postcss/pull/666</a></p>\n<p>发这个 Issue 的时候我刚下班，骑着自行车回家的途中发现收到了回复，我就停下车来，靠着自行车在成都万象城旁边傻站着摸着手机回复。</p>\n<p>PostCSS 的维护者告诉我应该使用异步的 API，我也就照做了，然后就发生了:</p>\n<p><img src=\"https://i.loli.net/2018/02/27/5a94fe69825e3.png\" alt=\"lol\"></p>\n<p>其实我当时还不太懂 Promise，经他指出之后研究了一下才发现一个函数已经返回了 Promise 就不用再把它 wrap 进一个 Promise 了:</p>\n<p><img src=\"https://i.loli.net/2018/02/27/5a94fec490e73.png\" alt=\"promise\"></p>\n<p>在这之后我也看到过其它人像我以前那样写，就感觉很好，因为我再也不会那么傻了。</p>\n<h2 id=\"2015-nian12-yue23-ri\">2015 年 12 月 23 日</h2>\n<p>开源两周后，这个项目迎来了<a href=\"https://github.com/egoist/rollup-plugin-postcss/issues/1\" target=\"_blank\" rel=\"external\">第一个 Issue</a>，我当时是很激动的:</p>\n<p><img src=\"https://i.loli.net/2018/02/27/5a9500dcc43a7.png\" alt=\"issue 1\"></p>\n<p>这个人可能在今天已经为读者们所熟知，也就是 <a href=\"https://github.com/developit/preact\" target=\"_blank\" rel=\"external\">Preact</a> 的作者，我记得在当时 Preact 还只有几百个 stars?</p>\n<h2 id=\"2016-nian5-yue29-ri\">2016 年 5 月 29 日</h2>\n<p>半年没更新这个项目了，难道是没人用吗，我也不知道因为我自己也不用。不过当时我似乎挺喜欢用 <a href=\"https://github.com/avajs/ava\" target=\"_blank\" rel=\"external\">AVA</a> 写测试，因为 CLI 效果很炫而且默认就支持用 ES2015 写测试。</p>\n<p>于是我就 commit 了一发<a href=\"https://github.com/egoist/rollup-plugin-postcss/commit/9698d66ca1f04a2308c94fe74d94d184f2891b96\" target=\"_blank\" rel=\"external\">将 Mocha 替换成 AVA</a> 了。</p>\n<h2 id=\"2016-nian9-yue2-ri\">2016 年 9 月 2 日</h2>\n<p>这天有人来了个 <a href=\"https://github.com/egoist/rollup-plugin-postcss/pull/5\" target=\"_blank\" rel=\"external\">PR</a>，尽管不知道 fix 了什么我还是合了吧?</p>\n<p>之后又来了一些 contributors，慢慢地我就懒得管了，基本全都是他们在 fix bugs 或者添加新 features，逐渐地我自己也看不懂里面的代码了 😅</p>\n<h2 id=\"2018-nian1-yue10-ri\">2018 年 1 月 10 日</h2>\n<p>过了一年多，我突然找回了责任心，想起了那句责任越大能力越大，打算重写一下这个项目。在此之前我折腾了很久的 webpack，于是就得到了一些重写的灵感，想让这个插件以 <code>loader</code> 的方式支持任何 CSS 预处理器，而且刚好 <a href=\"https://github.com/parcel-bundler/parcel\" target=\"_blank\" rel=\"external\">Parcel</a> 突然流行了起来，我也就顺便让它无需配置便能编译 CSS/Sass/Less/Stylus。和每次重构之后的心情一样，我再次觉得这次的代码写得很完美了。</p>\n<p><img src=\"https://i.loli.net/2018/02/27/5a9505707f0ea.png\" alt=\"current\"></p>\n<h2 id=\"2018-nian2-yue27-ri\">2018 年 2 月 27 日</h2>\n<p>今天，也就是我写这篇文章的日子，rollup-plugin-postcss 已被 <a href=\"https://github.com/egoist/rollup-plugin-postcss/network/dependents\" target=\"_blank\" rel=\"external\">900</a> 多个项目使用，其中包括像 <a href=\"https://github.com/developit/microbundle\" target=\"_blank\" rel=\"external\">microbundle</a> 和 <a href=\"https://github.com/egoist/bili\" target=\"_blank\" rel=\"external\">bili</a> 这样基于 Rollup 的打包工具。</p>\n<p>照目前的趋势来看，目前的代码还没有崩坏的迹象，在一段时间内可读性还能维持在较高范围。</p>\n<hr class=\"footnotes-sep\">\n<section class=\"footnotes\">\n<ol class=\"footnotes-list\">\n<li id=\"fn1\" class=\"footnote-item\"><p>我的笔名叫四月橘林，所以当时英文名就叫 April Orange XD <a href=\"#fnref1\" class=\"footnote-backref\">↩︎</a></p>\n</li>\n</ol>\n</section>\n"}